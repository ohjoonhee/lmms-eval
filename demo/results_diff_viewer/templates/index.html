<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Results Diff Viewer</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace; background: #1a1a2e; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }

  .top-bar { padding: 12px 16px; background: #16213e; border-bottom: 1px solid #0f3460; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .top-bar input[type="text"] { flex: 1; min-width: 200px; padding: 8px 12px; background: #0f3460; border: 1px solid #533483; color: #e0e0e0; border-radius: 4px; font-size: 13px; }
  .top-bar button, .filter-bar button { padding: 8px 16px; background: #533483; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
  .top-bar button:hover, .filter-bar button:hover { background: #6a42a0; }

  .filter-bar { padding: 8px 16px; background: #16213e; border-bottom: 1px solid #0f3460; display: flex; gap: 6px; align-items: center; flex-wrap: wrap; font-size: 13px; }
  .filter-bar select, .filter-bar input[type="text"] { padding: 6px 8px; background: #0f3460; border: 1px solid #533483; color: #e0e0e0; border-radius: 4px; font-size: 13px; }
  .filter-bar select { min-width: 120px; }
  .filter-bar .filter-group { display: flex; gap: 4px; align-items: center; }
  .filter-bar .label { color: #a0a0c0; font-weight: 600; min-width: 55px; }

  .main { flex: 1; display: flex; overflow: hidden; }
  .panel { flex: 1; overflow-y: auto; padding: 16px; border-right: 1px solid #0f3460; }
  .panel:last-child { border-right: none; }
  .panel-header { font-size: 14px; font-weight: 700; color: #a0a0c0; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #333; }

  .field-row { display: flex; padding: 4px 0; font-size: 13px; line-height: 1.5; border-bottom: 1px solid #222; }
  .field-key { color: #7fdbca; min-width: 160px; flex-shrink: 0; font-weight: 600; padding-right: 12px; word-break: break-all; }
  .field-val { color: #d6deeb; white-space: pre-wrap; word-break: break-word; flex: 1; }
  .field-val.diff { color: #ff6b6b; background: rgba(255, 107, 107, 0.1); padding: 2px 4px; border-radius: 2px; }
  .field-val.match { color: #a3be8c; }

  .response-box { margin-bottom: 16px; padding: 12px; background: #0d1b2a; border: 1px solid #1b2838; border-radius: 6px; font-size: 13px; line-height: 1.6; color: #d6deeb; white-space: pre-wrap; word-break: break-word; max-height: 300px; overflow-y: auto; }
  .response-box .think { color: #7c8fa6; font-style: italic; border-left: 3px solid #3a506b; padding-left: 8px; margin-bottom: 8px; display: block; }
  .response-box .answer { color: #e8e8e8; font-weight: 600; display: block; }
  .response-label { font-size: 12px; font-weight: 700; color: #a0a0c0; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }

  .score-bar { padding: 6px 16px; background: #16213e; border-bottom: 1px solid #0f3460; display: flex; gap: 6px; align-items: center; font-size: 13px; }
  .score-bar .label { color: #a0a0c0; font-weight: 600; }
  .score-bar input[type="text"] { padding: 6px 8px; background: #0f3460; border: 1px solid #533483; color: #e0e0e0; border-radius: 4px; font-size: 13px; width: 280px; }

  .score-badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 14px; font-weight: 700; margin-bottom: 10px; }
  .score-badge.good { background: rgba(163, 190, 140, 0.2); color: #a3be8c; border: 1px solid #a3be8c; }
  .score-badge.bad { background: rgba(255, 107, 107, 0.15); color: #ff6b6b; border: 1px solid #ff6b6b; }
  .score-badge.neutral { background: rgba(160, 160, 192, 0.15); color: #a0a0c0; border: 1px solid #555; }

  .nav-bar { padding: 10px 16px; background: #16213e; border-top: 1px solid #0f3460; display: flex; justify-content: center; align-items: center; gap: 16px; }
  .nav-bar button { padding: 8px 20px; background: #533483; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
  .nav-bar button:hover { background: #6a42a0; }
  .nav-bar button:disabled { background: #333; cursor: default; }
  .nav-bar .info { color: #a0a0c0; font-size: 14px; min-width: 120px; text-align: center; }

  .status { padding: 8px 16px; background: #0f3460; color: #a0a0c0; font-size: 12px; text-align: center; }
</style>
</head>
<body>

<div class="top-bar">
  <input type="text" id="path1" placeholder="Path to result1.jsonl (left)" value="{{ default_path1 }}">
  <input type="text" id="path2" placeholder="Path to result2.jsonl (right)" value="{{ default_path2 }}">
  <button onclick="loadFiles()">Load</button>
</div>

<div class="filter-bar">
  <div class="filter-group">
    <span class="label">Left:</span>
    <select id="f1-field"><option value="">-- field --</option></select>
    <select id="f1-op">
      <option value="==">=</option><option value="!=">!=</option>
      <option value=">">&gt;</option><option value="<">&lt;</option>
      <option value="contains">contains</option>
    </select>
    <input type="text" id="f1-val" placeholder="value" style="width:100px">
  </div>
  <div class="filter-group">
    <span class="label">Right:</span>
    <select id="f2-field"><option value="">-- field --</option></select>
    <select id="f2-op">
      <option value="==">=</option><option value="!=">!=</option>
      <option value=">">&gt;</option><option value="<">&lt;</option>
      <option value="contains">contains</option>
    </select>
    <input type="text" id="f2-val" placeholder="value" style="width:100px">
  </div>
  <button onclick="applyFilter()">Apply</button>
  <button onclick="resetFilter()">Reset</button>
</div>

<div class="score-bar">
  <span class="label">Score key:</span>
  <input type="text" id="score-key" placeholder="e.g. vstar_overall_llm_judge.score" value="{{ default_score_key }}">
</div>

<div class="main">
  <div class="panel" id="panel-left">
    <div class="panel-header">Result 1 (Left)</div>
    <div id="content-left"></div>
  </div>
  <div class="panel" id="panel-right">
    <div class="panel-header">Result 2 (Right)</div>
    <div id="content-right"></div>
  </div>
</div>

<div class="nav-bar">
  <button id="btn-prev" onclick="navigate(-1)" disabled>&larr; Prev</button>
  <span class="info" id="nav-info">No data loaded</span>
  <button id="btn-next" onclick="navigate(1)" disabled>Next &rarr;</button>
</div>

<div class="status" id="status">Load two JSONL files to begin comparing results.</div>

<script>
let currentIndex = 0;
let totalCount = 0;
let currentLeft = null;
let currentRight = null;

async function loadFiles() {
  const path1 = document.getElementById('path1').value.trim();
  const path2 = document.getElementById('path2').value.trim();
  if (!path1 || !path2) { setStatus('Please enter both file paths.'); return; }

  setStatus('Loading...');
  const res = await fetch('/api/load', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({path1, path2})
  });
  const data = await res.json();
  if (data.error) { setStatus('Error: ' + data.error); return; }

  totalCount = data.count;
  currentIndex = 0;
  populateFields('f1-field', data.fields1);
  populateFields('f2-field', data.fields2);
  setStatus(`Loaded ${data.total1} samples (left), ${data.total2} samples (right). ${data.count} aligned by doc_id.`);
  if (totalCount > 0) fetchSample(0);
  else updateNav();
}

function populateFields(id, fields) {
  const sel = document.getElementById(id);
  sel.innerHTML = '<option value="">-- field --</option>';
  fields.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f; opt.textContent = f;
    sel.appendChild(opt);
  });
}

async function fetchSample(index) {
  const res = await fetch(`/api/sample/${index}`);
  const data = await res.json();
  if (data.error) { setStatus('Error: ' + data.error); return; }

  currentIndex = data.index;
  totalCount = data.total;
  currentLeft = data.left;
  currentRight = data.right;
  renderPanels(data.left, data.right);
  updateNav();
}

function renderPanels(left, right) {
  const allKeys = new Set([...Object.keys(left || {}), ...Object.keys(right || {})]);
  const sortedKeys = Array.from(allKeys).sort();

  document.getElementById('content-left').innerHTML = renderResponse(left) + renderFields(left, right, sortedKeys);
  document.getElementById('content-right').innerHTML = renderResponse(right) + renderFields(right, left, sortedKeys);
}

function getNestedValue(obj, keyPath) {
  const parts = keyPath.split('.');
  let current = obj;
  for (const part of parts) {
    if (current == null || typeof current !== 'object') return undefined;
    current = current[part];
  }
  return current;
}

function renderScoreBadge(sample) {
  const scoreKey = document.getElementById('score-key').value.trim();
  if (!scoreKey || !sample) return '';
  const val = getNestedValue(sample, scoreKey);
  if (val === undefined || val === null) return `<span class="score-badge neutral">${escapeHtml(scoreKey)}: N/A</span>`;
  const numVal = Number(val);
  const isNum = !isNaN(numVal);
  const cls = isNum ? (numVal > 0 ? 'good' : 'bad') : 'neutral';
  const display = typeof val === 'object' ? JSON.stringify(val) : String(val);
  return `<span class="score-badge ${cls}">${escapeHtml(scoreKey)}: ${escapeHtml(display)}</span>`;
}

function renderResponse(sample) {
  if (!sample) return '';
  let html = renderScoreBadge(sample);
  if (sample.filtered_resps && sample.filtered_resps.length) {
    const raw = sample.filtered_resps[0];
    html += `<div class="response-label">Response</div><div class="response-box">${formatResponse(raw)}</div>`;
  }
  return html;
}

function formatResponse(text) {
  if (typeof text !== 'string') text = String(text);
  // Split on <think>...</think> blocks
  const parts = [];
  let remaining = text;
  const thinkRegex = /<think>([\s\S]*?)<\/think>/g;
  let lastIndex = 0;
  let m;
  while ((m = thinkRegex.exec(remaining)) !== null) {
    if (m.index > lastIndex) {
      parts.push({type: 'text', content: remaining.slice(lastIndex, m.index)});
    }
    parts.push({type: 'think', content: m[1]});
    lastIndex = m.index + m[0].length;
  }
  if (lastIndex < remaining.length) {
    parts.push({type: 'text', content: remaining.slice(lastIndex)});
  }
  return parts.map(p => {
    const escaped = escapeHtml(p.content.trim());
    if (p.type === 'think') return `<span class="think">${escaped}</span>`;
    return `<span class="answer">${escaped}</span>`;
  }).filter(s => s && !s.includes('></span>')).join('');
}

function renderFields(primary, other, keys) {
  return keys.map(key => {
    const val = primary ? primary[key] : undefined;
    const otherVal = other ? other[key] : undefined;
    const valStr = formatValue(val);
    const otherStr = formatValue(otherVal);
    const diffClass = (val !== undefined && otherVal !== undefined)
      ? (valStr === otherStr ? 'match' : 'diff')
      : '';
    return `<div class="field-row"><span class="field-key">${escapeHtml(key)}</span><span class="field-val ${diffClass}">${escapeHtml(valStr)}</span></div>`;
  }).join('');
}

function formatValue(val) {
  if (val === undefined || val === null) return '(missing)';
  if (typeof val === 'object') return JSON.stringify(val, null, 2);
  return String(val);
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function navigate(delta) {
  const newIndex = currentIndex + delta;
  if (newIndex >= 0 && newIndex < totalCount) fetchSample(newIndex);
}

function updateNav() {
  document.getElementById('nav-info').textContent = totalCount > 0
    ? `${currentIndex + 1} / ${totalCount}`
    : 'No samples';
  document.getElementById('btn-prev').disabled = currentIndex <= 0;
  document.getElementById('btn-next').disabled = currentIndex >= totalCount - 1;
}

async function applyFilter() {
  const filters = [];
  const f1f = document.getElementById('f1-field').value;
  const f1o = document.getElementById('f1-op').value;
  const f1v = document.getElementById('f1-val').value;
  if (f1f) filters.push({side: 'left', field: f1f, op: f1o, value: f1v});

  const f2f = document.getElementById('f2-field').value;
  const f2o = document.getElementById('f2-op').value;
  const f2v = document.getElementById('f2-val').value;
  if (f2f) filters.push({side: 'right', field: f2f, op: f2o, value: f2v});

  if (filters.length === 0) { setStatus('Set at least one filter.'); return; }

  setStatus('Filtering...');
  const res = await fetch('/api/filter', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({filters})
  });
  const data = await res.json();
  totalCount = data.count;
  currentIndex = 0;
  setStatus(`Filter applied: ${data.count} samples match.`);
  if (totalCount > 0) fetchSample(0);
  else { document.getElementById('content-left').innerHTML = ''; document.getElementById('content-right').innerHTML = ''; updateNav(); }
}

async function resetFilter() {
  const res = await fetch('/api/reset_filter', {method: 'POST'});
  const data = await res.json();
  totalCount = data.count;
  currentIndex = 0;
  setStatus(`Filter reset: ${data.count} samples.`);
  if (totalCount > 0) fetchSample(0);
  else updateNav();
}

function setStatus(msg) { document.getElementById('status').textContent = msg; }

document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  if (e.key === 'ArrowLeft') navigate(-1);
  else if (e.key === 'ArrowRight') navigate(1);
});

// Re-render panels when score key changes
document.getElementById('score-key').addEventListener('input', () => {
  if (currentLeft && currentRight) renderPanels(currentLeft, currentRight);
});

// Auto-load if paths are pre-filled
window.addEventListener('DOMContentLoaded', () => {
  const p1 = document.getElementById('path1').value.trim();
  const p2 = document.getElementById('path2').value.trim();
  if (p1 && p2) loadFiles();
});
</script>
</body>
</html>
